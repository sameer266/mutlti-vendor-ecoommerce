{% extends 'dashboard/components/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-7xl mx-auto p-4 sm:p-6">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900">Purchase Invoices</h1>
        <p class="text-sm text-gray-500 mt-1">View and manage purchase invoices</p>
      </div>
      <a href="{% url 'admin_purchases_list' %}" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-200 transition-colors">
        <i class="fas fa-shopping-cart mr-1"></i> View Purchases
      </a>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white border border-gray-200 p-4 rounded-lg">
      <div class="text-xs text-gray-600 mb-1">Total Invoices</div>
      <div class="text-xl font-semibold text-gray-900">{{ total_invoices }}</div>
    </div>
    <div class="bg-white border border-gray-200 p-4 rounded-lg">
      <div class="text-xs text-gray-600 mb-1">Total Amount</div>
      <div class="text-xl font-semibold text-gray-900">Rs. {{ total_amount|floatformat:2 }}</div>
    </div>
    <div class="bg-white border border-gray-200 p-4 rounded-lg">
      <div class="text-xs text-gray-600 mb-1">Total Paid</div>
      <div class="text-xl font-semibold text-gray-900">Rs. {{ total_paid|floatformat:2 }}</div>
    </div>
    <div class="bg-white border border-gray-200 p-4 rounded-lg">
      <div class="text-xs text-gray-600 mb-1">Total Pending</div>
      <div class="text-xl font-semibold text-gray-900">Rs. {{ total_pending|floatformat:2 }}</div>
    </div>
  </div>

  <!-- Filter Form -->
  <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
    <form method="get">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
        <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search invoices..." class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent" />
        
        <input type="text" name="supplier" value="{{ request.GET.supplier }}" placeholder="Supplier name" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent" />
        
        <select name="payment_status" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent">
          <option value="">Payment Status</option>
          <option value="pending" {% if request.GET.payment_status == 'pending' %}selected{% endif %}>Pending</option>
          <option value="paid" {% if request.GET.payment_status == 'paid' %}selected{% endif %}>Paid</option>
          <option value="partial" {% if request.GET.payment_status == 'partial' %}selected{% endif %}>Partial</option>
          <option value="overdue" {% if request.GET.payment_status == 'overdue' %}selected{% endif %}>Overdue</option>
        </select>
        
        <input type="date" name="date_from" value="{{ request.GET.date_from }}" placeholder="From Date" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent" />
        
        <div class="flex gap-2">
          <button class="bg-gray-900 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-800 transition-colors flex-1">Filter</button>
          <a href="?" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-200 transition-colors flex-1 text-center">Reset</a>
        </div>
      </div>
    </form>
  </div>

  <!-- Invoices Table -->
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table id="invoicesTable" class="w-full border-collapse">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 border-b border-gray-200">Invoice #</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 border-b border-gray-200">Date</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 border-b border-gray-200">Supplier</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 border-b border-gray-200">Products</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 border-b border-gray-200">Items</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-700 border-b border-gray-200">Amount</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 border-b border-gray-200">Payment</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 border-b border-gray-200">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in invoices %}
          <tr class="hover:bg-gray-50 border-b border-gray-200">
            <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ invoice.invoice_number }}</td>
            <td class="px-4 py-3">
              <div class="text-sm text-gray-900">{{ invoice.purchase_date|date:"M d, Y" }}</div>
              <div class="text-xs text-gray-500">{{ invoice.created_at|date:"g:i A" }}</div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-900">{{ invoice.supplier_name }}</td>
            <td class="px-4 py-3">
              <div class="space-y-1">
                {% for item in invoice.items.all|slice:":3" %}
                  <div class="text-sm">
                    <span class="text-gray-900">{{ item.product_name }}</span>
                    {% if item.product_sku %}
                      <span class="text-gray-500">({{ item.product_sku }})</span>
                    {% endif %}
                    <span class="text-gray-600">- Qty: {{ item.quantity }}</span>
                  </div>
                {% endfor %}
                {% if invoice.items.count > 3 %}
                  <span class="text-xs text-gray-500">+ {{ invoice.items.count|add:"-3" }} more</span>
                {% endif %}
              </div>
            </td>
            <td class="px-4 py-3 text-sm text-center text-gray-900">{{ invoice.items.count }}</td>
            <td class="px-4 py-3 text-sm text-right font-medium text-gray-900">Rs. {{ invoice.total_amount|floatformat:2 }}</td>
            <td class="px-4 py-3">
              <select class="payment-status-select border border-gray-300 rounded px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent" 
                      data-invoice-number="{{ invoice.invoice_number }}"
                      data-current-status="{{ invoice.payment_status }}">
                <option value="pending" {% if invoice.payment_status == 'pending' %}selected{% endif %}>Pending</option>
                <option value="paid" {% if invoice.payment_status == 'paid' %}selected{% endif %}>Paid</option>
                <option value="partial" {% if invoice.payment_status == 'partial' %}selected{% endif %}>Partial</option>
                <option value="overdue" {% if invoice.payment_status == 'overdue' %}selected{% endif %}>Overdue</option>
              </select>
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center justify-center">
                <a href="{% url 'admin_purchase_invoice_detail' invoice.invoice_number %}" class="text-gray-600 hover:text-gray-900 p-1.5" title="View Invoice">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="px-4 py-12 text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <p class="text-sm text-gray-500 mt-2">No invoices found</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function () {
    // Datatable Initialization
    $('#invoicesTable').DataTable({
      order: [[1, 'desc']],
      pageLength: 10,
      lengthChange: true,
      searching: true,
      ordering: true,
      responsive: true,
      language: {
        search: "_INPUT_",
        searchPlaceholder: "Search..."
      },
      columnDefs: [
        { orderable: false, targets: [-1, -2] }
      ],
      drawCallback: function() {
        $('#invoicesTable tbody tr').addClass('border-b border-gray-200');
      }
    });
    
    // Handle payment status change
    $('.payment-status-select').on('change', function() {
      const select = $(this);
      const invoiceNumber = select.data('invoice-number');
      const newStatus = select.val();
      const currentStatus = select.data('current-status');
      
      if (newStatus === currentStatus) {
        return;
      }
      
      Swal.fire({
        title: 'Confirm Change',
        text: `Change payment status to "${newStatus}"?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#111827',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, change it',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (!result.isConfirmed) {
          select.val(currentStatus);
          return;
        }
        
        select.prop('disabled', true);
        
        Swal.fire({
          title: 'Updating...',
          text: 'Please wait',
          allowOutsideClick: false,
          allowEscapeKey: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        const csrfToken = document.querySelector('[name=csrf-token]')?.content || 
                          document.querySelector('input[name=csrfmiddlewaretoken]')?.value ||
                          '{{ csrf_token }}';
        
        $.ajax({
          url: `/admin-dashboard/api/purchase-invoices/${invoiceNumber}/payment-status/`,
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
          },
          data: JSON.stringify({
            payment_status: newStatus,
            payment_date: newStatus === 'paid' ? new Date().toISOString().split('T')[0] : ''
          }),
          success: function(response) {
            if (response.success) {
              select.data('current-status', newStatus);
              select.prop('disabled', false);
              
              Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'Payment status updated',
                timer: 2000,
                showConfirmButton: false
              });
            } else {
              select.val(currentStatus);
              select.prop('disabled', false);
              
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: response.error || 'Failed to update'
              });
            }
          },
          error: function(xhr) {
            select.val(currentStatus);
            select.prop('disabled', false);
            const errorMsg = xhr.responseJSON?.error || 'Failed to update';
            
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: errorMsg
            });
          }
        });
      });
    });
  });
</script>
{% endblock %}