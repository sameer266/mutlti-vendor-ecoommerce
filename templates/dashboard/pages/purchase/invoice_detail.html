{% extends 'dashboard/components/base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8 px-4 print:bg-white print:py-0">
  
  <!-- Action Buttons (Hidden on Print) -->
  <div class="max-w-4xl mx-auto mb-4 flex justify-between items-center print:hidden">
  <a href="javascript:void(0);"
   onclick="window.history.back();"
   class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
  <i class="fa-solid fa-arrow-left"></i>
  <span>Back</span>
</a>

    <div class="flex gap-2">
      <button onclick="window.print()" 
         class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition">
        <i class="fa-solid fa-print"></i>
        <span>Print</span>
      </button>
      <button onclick="openPaymentModal()" 
         class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 rounded-lg  transition">
        <i class="fas fa-money-bill"></i>
        <span>Update Payment</span>
      </button>
    </div>
  </div>

  <!-- Invoice Container -->
  <div class="max-w-4xl mx-auto bg-white shadow-sm border border-gray-200 print:shadow-none print:border-0">
    
    <!-- Invoice Header -->
    <div class="p-8 border-b border-gray-200">
      <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-6">
        
        <!-- Company Info -->
        <div class="flex-1">
          {% if organization %}
            <h1 class="text-2xl font-bold text-gray-900 mb-3">{{ organization.name }}</h1>
            <div class="text-sm text-gray-600 space-y-1">
              {% if organization.address %}<p>{{ organization.address }}</p>{% endif %}
              {% if organization.phone %}<p>{{ organization.phone }}</p>{% endif %}
              {% if organization.email %}<p>{{ organization.email }}</p>{% endif %}
            </div>
          {% else %}
            <h1 class="text-2xl font-bold text-gray-900">Purchase Invoice</h1>
          {% endif %}
        </div>
        
        <!-- Invoice Details -->
        <div class="flex-shrink-0 text-left md:text-right">
          <h2 class="text-xl font-bold text-gray-900 mb-3">INVOICE</h2>
          <div class="text-sm space-y-1">
            <p><span class="text-gray-600">Invoice #:</span> <span class="font-medium">{{ invoice.invoice_number }}</span></p>
            <p><span class="text-gray-600">Date:</span> <span class="font-medium">{{ invoice.purchase_date|date:"M d, Y" }}</span></p>
            {% if invoice.purchase_order_number %}
              <p><span class="text-gray-600">PO #:</span> <span class="font-medium">{{ invoice.purchase_order_number }}</span></p>
            {% endif %}
            {% if invoice.supplier_invoice_number %}
              <p><span class="text-gray-600">Supplier Invoice:</span> <span class="font-medium">{{ invoice.supplier_invoice_number }}</span></p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Supplier & Status Info -->
    <div class="p-8 border-b border-gray-200">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        
        <!-- Supplier Details -->
        <div>
          <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Supplier</h3>
          <div class="space-y-1">
            <p class="font-semibold text-gray-900">{{ invoice.supplier_name }}</p>
            {% if invoice.supplier_address %}
              <p class="text-sm text-gray-600">{{ invoice.supplier_address }}</p>
            {% endif %}
            {% if invoice.supplier_city %}
              <p class="text-sm text-gray-600">{{ invoice.supplier_city }}</p>
            {% endif %}
            {% if invoice.supplier_phone %}
              <p class="text-sm text-gray-600">{{ invoice.supplier_phone }}</p>
            {% endif %}
            {% if invoice.supplier_email %}
              <p class="text-sm text-gray-600">{{ invoice.supplier_email }}</p>
            {% endif %}
          </div>
        </div>
        
        <!-- Payment Status -->
        <div>
          <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Payment Information</h3>
          <div class="space-y-2">
            <div>
              <span class="text-sm text-gray-600">Status: </span>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                {% if invoice.payment_status == 'paid' %}bg-green-100 text-green-800
                {% elif invoice.payment_status == 'pending' %}bg-yellow-100 text-yellow-800
                {% elif invoice.payment_status == 'partial' %}bg-blue-100 text-blue-800
                {% elif invoice.payment_status == 'overdue' %}bg-red-100 text-red-800
                {% endif %}">
                {{ invoice.payment_status|title }}
              </span>
            </div>
            {% if invoice.payment_date %}
              <p class="text-sm"><span class="text-gray-600">Paid on:</span> <span class="font-medium">{{ invoice.payment_date|date:"M d, Y" }}</span></p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Items Table -->
    <div class="p-8 border-b border-gray-200">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b-2 border-gray-300">
            <th class="py-3 text-left font-semibold text-gray-700">#</th>
            <th class="py-3 text-left font-semibold text-gray-700">Item</th>
            <th class="py-3 text-left font-semibold text-gray-700">SKU</th>
            <th class="py-3 text-right font-semibold text-gray-700">Qty</th>
            <th class="py-3 text-right font-semibold text-gray-700">Price</th>
            <th class="py-3 text-right font-semibold text-gray-700">Amount</th>
          </tr>
        </thead>
        <tbody>
          {% for item in invoice.items.all %}
          <tr class="border-b border-gray-100">
            <td class="py-4 text-gray-600">{{ forloop.counter }}</td>
            <td class="py-4 font-medium text-gray-900">{{ item.product_name }}</td>
            <td class="py-4 text-gray-600">{{ item.product_sku|default:"-" }}</td>
            <td class="py-4 text-right text-gray-900">{{ item.quantity }}</td>
            <td class="py-4 text-right text-gray-600">Rs. {{ item.unit_price|floatformat:2 }}</td>
            <td class="py-4 text-right font-medium text-gray-900">Rs. {{ item.total|floatformat:2 }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="py-8 text-center text-gray-500">No items found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Summary -->
    <div class="p-8">
      <div class="flex justify-end">
        <div class="w-full md:w-80 space-y-3">
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Subtotal</span>
            <span class="font-medium text-gray-900">Rs. {{ invoice.subtotal|floatformat:2 }}</span>
          </div>
          {% if invoice.tax_amount > 0 %}
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Tax</span>
            <span class="font-medium text-gray-900">Rs. {{ invoice.tax_amount|floatformat:2 }}</span>
          </div>
          {% endif %}
          {% if invoice.discount > 0 %}
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Discount</span>
            <span class="font-medium text-red-600">-Rs. {{ invoice.discount|floatformat:2 }}</span>
          </div>
          {% endif %}
          <div class="flex justify-between pt-3 border-t-2 border-gray-300">
            <span class="font-semibold text-gray-900">Total</span>
            <span class="text-xl font-bold text-gray-900">Rs. {{ invoice.total_amount|floatformat:2 }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes -->
    {% if invoice.notes %}
    <div class="p-8 border-t border-gray-200 bg-gray-50">
      <h4 class="text-sm font-semibold text-gray-700 mb-2">Notes</h4>
      <p class="text-sm text-gray-600">{{ invoice.notes }}</p>
    </div>
    {% endif %}

    <!-- Footer -->
    <div class="p-8 border-t border-gray-200 text-center">
      <p class="text-xs text-gray-500">Thank you for your business</p>
      <p class="text-xs text-gray-400 mt-1">Invoice generated on {{ invoice.created_at|date:"M d, Y" }}</p>
    </div>

  </div>
</div>

<!-- Payment Update Modal -->
<div id="paymentModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
    <div class="p-6 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-900">Update Payment Status</h3>
        <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <form id="paymentForm" class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Status</label>
        <select id="paymentStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="pending" {% if invoice.payment_status == 'pending' %}selected{% endif %}>Pending</option>
          <option value="paid" {% if invoice.payment_status == 'paid' %}selected{% endif %}>Paid</option>
          <option value="partial" {% if invoice.payment_status == 'partial' %}selected{% endif %}>Partially Paid</option>
          <option value="overdue" {% if invoice.payment_status == 'overdue' %}selected{% endif %}>Overdue</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Date</label>
        <input type="date" id="paymentDate" 
               value="{% if invoice.payment_date %}{{ invoice.payment_date|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div class="flex gap-3 pt-2">
        <button type="submit" 
                class="flex-1 px-4 py-2 bg-gray-900 hover:bg-gray-800 text-white rounded-lg transition font-medium">
          Update
        </button>
        <button type="button" onclick="closePaymentModal()"
                class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function openPaymentModal() {
  document.getElementById('paymentModal').classList.remove('hidden');
}

function closePaymentModal() {
  document.getElementById('paymentModal').classList.add('hidden');
}

// Close modal on outside click
document.getElementById('paymentModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closePaymentModal();
  }
});

// Handle form submission
document.getElementById('paymentForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = 'Updating...';
  
  const status = document.getElementById('paymentStatus').value;
  const date = document.getElementById('paymentDate').value;
  const csrfToken = '{{ csrf_token }}';
  
  fetch(`/admin-dashboard/api/purchase-invoices/{{ invoice.invoice_number }}/payment-status/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      payment_status: status,
      payment_date: date
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      closePaymentModal();
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to update payment status'));
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  })
  .catch(error => {
    alert('Error: Failed to update payment status');
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  });
});
</script>

<style>
@media print {
  @page {
    margin: 1cm;
    size: A4;
  }
  
  body {
    margin: 0;
    padding: 0;
  }
  
  .print\\:hidden {
    display: none !important;
  }
  
  .print\\:bg-white {
    background-color: white !important;
  }
  
  .print\\:py-0 {
    padding-top: 0 !important;
    padding-bottom: 0 !important;
  }
  
  .print\\:shadow-none {
    box-shadow: none !important;
  }
  
  .print\\:border-0 {
    border: 0 !important;
  }
  
  /* Ensure colors print correctly */
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  /* Prevent page breaks inside elements */
  table, tr, td, th {
    page-break-inside: avoid;
  }
  
  /* Keep header on each page if multi-page */
  thead {
    display: table-header-group;
  }
}
</style>
{% endblock %}