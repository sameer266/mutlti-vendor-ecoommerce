{% extends 'dashboard/components/base.html' %}
{% load static %}

{% block content %}
<div class="bg-white rounded-xl shadow p-6">
  <!-- Header -->
  <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
    <h1 class="text-2xl font-semibold text-gray-800"><i class="fas fa-store"></i> Vendors</h1>
    <a href="{% url 'admin_vendor_add' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
      + Add Vendor
    </a>
  </div>

  <!-- Filter Form -->
  <form method="get" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-3">
    <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search by shop, email, phone, or owner"
      class="border border-gray-300 rounded-lg px-3 py-2 w-full" />

    <select name="status" class="border border-gray-300 rounded-lg px-3 py-2 w-full">
      <option value="">All Status</option>
      <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
      <option value="verified" {% if request.GET.status == 'verified' %}selected{% endif %}>Verified</option>
      <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
    </select>

    <div class="flex gap-2">
      <button class="bg-gray-800 text-white px-4 py-2 rounded-lg w-full md:w-auto">Filter</button>
      <a href="?" class="px-4 py-2 rounded-lg border w-full md:w-auto text-gray-700 hover:bg-gray-100">Reset</a>
    </div>
  </form>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-4 py-3 text-left">Shop</th>
          <th class="px-4 py-3 text-left">Owner</th>
          <th class="px-4 py-3 text-left">Contact</th>
          <th class="px-4 py-3 text-left">Documents</th>
          <th class="px-4 py-3 text-left">Payment QR</th>
          <th class="px-4 py-3 text-left">Status</th>
          <th class="px-4 py-3 text-left">Created</th>
          <th class="px-4 py-3 text-center">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for vendor in vendors %}
        <tr class="hover:bg-gray-50 border-b align-top">
          <!-- Shop Info -->
          <td class="px-4 py-4">
            <div class="flex items-start gap-3">
              {% if vendor.shop_logo %}
                <img src="{{ vendor.shop_logo.url }}" alt="logo" class="w-12 h-12 object-cover rounded border" />
              {% endif %}
              <div class="flex-1">
                <div class="font-semibold text-gray-800">{{ vendor.shop_name }}</div>
                {% if vendor.shop_banner %}
                  <a href="{{ vendor.shop_banner.url }}" target="_blank" class="text-xs text-blue-600 hover:underline">View Banner</a>
                {% endif %}
                {% if vendor.description %}
                <p class="text-xs text-gray-600 mt-1 description-text">
                  {% if vendor.description|length > 80 %}
                    <span class="short-desc">{{ vendor.description|slice:":80" }}...</span>
                    <span class="full-desc hidden">{{ vendor.description }}</span>
                    <a href="#" class="text-blue-600 text-xs see-more-btn">See more</a>
                  {% else %}
                    {{ vendor.description }}
                  {% endif %}
                </p>
                {% endif %}
                <p class="text-xs text-gray-500 mt-1">{{ vendor.address }}, {{ vendor.city }} ({{ vendor.get_province_display }})</p>
              </div>
            </div>
          </td>

          <!-- Owner -->
          <td class="px-4 py-4">
            {% if vendor.user %}
              <div class="font-medium">{{ vendor.user.first_name}} {{vendor.user.last_name}}</div>
            {% else %}
              <span class="text-gray-400">N/A</span>
            {% endif %}
          </td>

          <!-- Contact -->
          <td class="px-4 py-4">
            <div>{{ vendor.user.email }}</div>
            <div class="text-gray-600">{{ vendor.phone }}</div>
          </td>

          <!-- Documents -->
          <td class="px-4 py-4 text-sm">
            {% if vendor.pan_number %}<div class="font-medium text-gray-800">PAN: {{ vendor.pan_number }}</div>{% endif %}
            {% if vendor.pan_document %}<a href="{{ vendor.pan_document.url }}" target="_blank" class="text-blue-600 text-xs hover:underline">View PAN</a>{% endif %}

            {% if vendor.citizenship_number %}
            <div class="mt-1 text-gray-800 text-xs">Citizenship: {{ vendor.citizenship_number }}</div>
            <div class="flex gap-2 mt-1">
              {% if vendor.citizenship_front %}<a href="{{ vendor.citizenship_front.url }}" target="_blank" class="text-blue-600 text-xs hover:underline">Front</a>{% endif %}
              {% if vendor.citizenship_back %}<a href="{{ vendor.citizenship_back.url }}" target="_blank" class="text-blue-600 text-xs hover:underline">Back</a>{% endif %}
            </div>
            {% endif %}

            {% if vendor.company_registration %}<div class="mt-1"><a href="{{ vendor.company_registration.url }}" target="_blank" class="text-blue-600 text-xs hover:underline">Company Reg.</a></div>{% endif %}
          </td>

          <!-- Payment QR -->
          <td class="px-4 py-4 text-center">
            {% if vendor.qr_image %}
              <a href="{{ vendor.qr_image.url }}" target="_blank" title="Click to view QR code">
                <img src="{{ vendor.qr_image.url }}" alt="QR Code" class="w-20 h-20 object-contain rounded border p-1 hover:shadow-lg transition" />
              </a>
            {% else %}
              <span class="text-gray-400 text-xs">N/A</span>
            {% endif %}
          </td>

          <!-- Status -->
          <td class="px-4 py-4">
            {% if vendor.verification_status == 'verified' %}
              <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs font-semibold">Verified</span>
            {% elif vendor.verification_status == 'pending' %}
              <span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full text-xs font-semibold">Pending</span>
            {% elif vendor.verification_status == 'rejected' %}
              <span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs font-semibold">Rejected</span>
            {% endif %}
            {% if vendor.verified_at %}<div class="text-xs text-gray-500 mt-1">Updated: {{ vendor.verified_at|date:"Y-m-d H:i" }}</div>{% endif %}
            {% if vendor.rejection_reason %}<div class="text-xs text-red-600 mt-1">Reason: {{ vendor.rejection_reason }}</div>{% endif %}
          </td>

          <!-- Created -->
          <td class="px-4 py-4 text-gray-700">{{ vendor.created_at|date:"Y-m-d H:i" }}</td>

          <!-- Actions -->
          <td class="px-4 py-4 text-center space-x-3">
            <a href="{% url 'admin_vendor_update' vendor.id %}" class="text-blue-600 hover:text-blue-800" title="Edit Vendor"><i class="fas fa-edit"></i></a>
            <a href="{% url 'admin_vendor_delete' vendor.id %}" onclick="return confirm('Delete this vendor?')" class="text-red-600 hover:text-red-800" title="Delete Vendor"><i class="fas fa-trash-alt"></i></a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center text-gray-500 py-6">No vendors found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
$(document).ready(function() {
  // See more / See less toggle
  $(document).on('click', '.see-more-btn', function(e) {
    e.preventDefault();
    const $btn = $(this);
    const $desc = $btn.closest('.description-text');
    $desc.find('.short-desc, .full-desc').toggleClass('hidden');
    $btn.text($desc.find('.short-desc').hasClass('hidden') ? 'See less' : 'See more');
  });
});
</script>
{% endblock %}
