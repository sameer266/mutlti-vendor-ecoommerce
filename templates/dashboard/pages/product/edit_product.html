{% extends 'dashboard/components/base.html' %}
{% load static %}

{% block content %}
<div class="bg-white rounded-xl shadow p-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-semibold text-gray-800">Edit Product</h1>
    <a href="{% url 'vendor_products_list' %}" class="text-sm text-blue-600 hover:text-blue-800">Back to list</a>
  </div>

  <form method="post" action="{% url 'admin_product_update' product.id %}" enctype="multipart/form-data" class="space-y-6">
    {% csrf_token %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="block text-sm font-medium text-gray-700">Vendor</label>
        <select name="vendor" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5" required>
          {% for v in vendors %}
            <option value="{{ v.id }}" {% if product.vendor.id == v.id %}selected{% endif %}>{{ v.shop_name }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Category</label>
        <select name="category" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5" required>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if product.category and product.category.id == c.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700">Name</label>
        <input type="text" name="name" value="{{ product.name }}" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5" required>
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700">Description</label>
        <textarea id="description" name="description" rows="4" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5" required>{{ product.description }}</textarea>
      </div>

      

      <div>
        <label class="block text-sm font-medium text-gray-700">Price</label>
        <input type="number" step="0.01" name="price" value="{{ product.price }}" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5" required>
      </div>

      

      <div>
        <label class="block text-sm font-medium text-gray-700">Cost Price</label>
        <input type="number" step="0.01" name="cost_price" value="{{ product.cost_price }}" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5">
      </div>


      <div>
        <label class="block text-sm font-medium text-gray-700">Stock</label>
        <input type="number" name="stock" value="{{ product.stock }}" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5" required>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Low Stock Alert</label>
        <input type="number" name="low_stock_alert" value="{{ product.low_stock_alert }}" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Brand</label>
        <input type="text" name="brand" value="{{ product.brand }}" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Weight (kg)</label>
        <input type="number" step="0.01" name="weight" value="{{ product.weight }}" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5">
      </div>

      <div class="md:col-span-2 pt-2">
        <label class="inline-flex items-center text-sm text-gray-700">
          <input type="checkbox" name="is_featured" class="mr-2" {% if product.is_featured %}checked{% endif %}>
          Featured product
        </label>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Main Image</label>
        {% if product.main_image %}
          <img src="{{ product.main_image.url }}" alt="{{ product.name }}" class="h-12 mb-2"/>
        {% endif %}
        <input type="file" name="main_image" accept="image/*" class="mt-1 block w-full">
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700">Add Gallery Images</label>
        <input type="file" name="gallery_images" accept="image/*" class="mt-1 block w-full" multiple>
        <p class="text-xs text-gray-500 mt-1">Existing:</p>
        <div class="flex items-center space-x-2 mt-1">
          {% for img in product.images.all %}
            <img src="{{ img.image.url }}" alt="img" class="h-10 w-10 object-cover rounded"/>
          {% empty %}
            <span class="text-gray-400">No gallery images</span>
          {% endfor %}
        </div>
      </div>


      
    </div>

    <div class="pt-2">
      <h2 class="text-lg font-semibold text-gray-800 mb-2">Variants</h2>
      <div class="space-y-3">
        {% for v in product.variants.all %}
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end border border-gray-200 rounded-lg p-3">
          <input type="hidden" name="existing_variant_id[]" value="{{ v.id }}" />
          <div>
            <label class="block text-sm font-medium text-gray-700">Type</label>
            <select name="existing_variant_type[]" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5">
    <option value="size" {% if v.variant_type == 'size' %}selected{% endif %}>Size</option>
    <option value="color" {% if v.variant_type == 'color' %}selected{% endif %}>Color</option>
    <option value="weight" {% if v.variant_type == 'weight' %}selected{% endif %}>Weight</option>
    <option value="storage" {% if v.variant_type == 'storage' %}selected{% endif %}>Storage Capacity</option>
    <option value="ram" {% if v.variant_type == 'ram' %}selected{% endif %}>RAM</option>
    <option value="material" {% if v.variant_type == 'material' %}selected{% endif %}>Material</option>
    <option value="style" {% if v.variant_type == 'style' %}selected{% endif %}>Style</option>
    <option value="pattern" {% if v.variant_type == 'pattern' %}selected{% endif %}>Pattern</option>
    <option value="flavor" {% if v.variant_type == 'flavor' %}selected{% endif %}>Flavor</option>
    <option value="other" {% if v.variant_type == 'other' %}selected{% endif %}>Other</option>
</select>

          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Name</label>
            <input type="text" name="existing_variant_name[]" value="{{ v.name }}" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Price Adj.</label>
            <input type="number" step="0.01" name="existing_variant_price_adjustment[]" value="{{ v.price_adjustment }}" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5" />
          </div>
          
          <div class="pt-6">
            <label class="inline-flex items-center text-sm text-red-600">
              <input type="checkbox" name="existing_variant_delete[]" value="{{ v.id }}" class="mr-2"> Delete
            </label>
          </div>
        </div>
        {% empty %}
        <p class="text-sm text-gray-500">No variants yet.</p>
        {% endfor %}
      </div>

      <div class="mt-4">
        <h3 class="text-md font-medium text-gray-800 mb-2">Add New Variants</h3>
        <div id="variantsContainer" class="space-y-3"></div>
        <button type="button" id="addVariantBtn" class="mt-2 bg-gray-200 text-gray-800 px-3 py-1 rounded">+ Add Variant</button>
      </div>
    </div>

    <div class="pt-4">
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Update Product</button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.ckeditor.com/4.21.0/standard/ckeditor.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const textarea = document.querySelector('textarea[name="description"]');
    if (textarea) {
      CKEDITOR.replace('description', {
        height: 300,
        toolbar: [
          { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike'] },
          { name: 'paragraph', items: [
              'NumberedList', 'BulletedList', '-', 
              'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'
          ]},
          { name: 'styles', items: ['Font', 'FontSize'] },
          { name: 'colors', items: ['TextColor', 'BGColor'] },
          { name: 'insert', items: ['Link', 'Unlink', 'Image'] },
          { name: 'tools', items: ['RemoveFormat', 'Source'] } // optional tools
        ],
        removePlugins: 'elementspath', // hide element path at bottom
        resize_enabled: false,
        font_names: 'Arial;Comic Sans MS;Courier New;Georgia;Tahoma;Times New Roman;Verdana',
        fontSize_sizes: '12/12px;14/14px;16/16px;18/18px;20/20px;24/24px;28/28px'
      });
    }
  });
</script>


<script>
  (function(){
    const variantsContainer = document.getElementById('variantsContainer');
    const addVariantBtn = document.getElementById('addVariantBtn');
    if (addVariantBtn) {
      addVariantBtn.addEventListener('click', function(){
        const row = document.createElement('div');
        row.className = 'grid grid-cols-1 md:grid-cols-4 gap-3 items-end';
        row.innerHTML = `
          <div>
            <label class="block text-sm font-medium text-gray-700">Type</label>
            <select name="variant_type[]" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5">
       <option value="size">Size</option>
    <option value="color">Color</option>
    <option value="weight">Weight</option>
    <option value="storage">Storage Capacity</option>
    <option value="ram">RAM</option>
    <option value="material">Material</option>
    <option value="style">Style</option>
    <option value="pattern">Pattern</option>
    <option value="flavor">Flavor</option>
    <option value="other" selected>Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Name</label>
            <input type="text" name="variant_name[]" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5" placeholder="e.g., XL, Red" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Price Adj.</label>
            <input type="number" step="0.01" name="variant_price_adjustment[]" class="mt-1 block w-full border border-gray-300 rounded-lg p-2.5" value="0" />
          </div>
          
        `;
        variantsContainer.appendChild(row);
      });
    }
  })();
</script>
{% endblock %}


