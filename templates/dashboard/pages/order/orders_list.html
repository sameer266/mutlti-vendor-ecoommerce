{% extends 'dashboard/components/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow p-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-semibold text-gray-800"><i class="fas fa-shopping-cart"></i> Orders</h1>
    <a href="#" class="opacity-60 cursor-not-allowed text-sm">Add Order (disabled)</a>
  </div>

  <form method="get" class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-4">
    <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search #, name, email, phone" class="border border-gray-300 rounded-lg p-2.5" />
    
    <select name="status" class="border border-gray-300 rounded-lg p-2.5">
      <option value="">All Status</option>
      {% for value,label in order_model.STATUS_CHOICES %}
        <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    
    <select name="payment_status" class="border border-gray-300 rounded-lg p-2.5">
      <option value="">All Payment</option>
      {% for value,label in order_model.PAYMENT_STATUS_CHOICES %}
        <option value="{{ value }}" {% if request.GET.payment_status == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    
    <div>
      <button class="bg-gray-800 text-white px-4 py-2 rounded-lg w-full">Filter</button>
    </div>
  </form>

  <div class="overflow-x-auto">
    <table id="ordersTable" class="display w-full border border-gray-200 rounded-lg text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th>Order #</th>
          <th>Customer</th>
          <th>Contact</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Status</th>
          <th>Estimated Delivery Date</th>
          <th>Delivered At</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr>
          <td>{{ order.order_number }}</td>
          <td>{{ order.full_name }}</td>
          <td>
            {{ order.email }}<br>
            <span class="text-xs text-gray-500">{{ order.phone }}</span>
          </td>
          <td>Rs {{ order.total }}</td>
          <td>
            {% for value,label in order_model.PAYMENT_STATUS_CHOICES %}
              {% if order.payment_status == value %}
                {{ label }}
              {% endif %}
            {% endfor %}
          </td>
          <td>
            <select class="status-select border rounded p-1" data-id="{{ order.order_number }}">
              {% for value,label in order_model.STATUS_CHOICES %}
                <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </td>
          <td>{{ order.estimated_shipping_date|date:"Y-m-d"|default:"No Date" }}</td>
          <td>{{ order.delivered_at|date:"Y-m-d h:i A" }}</td>
          <td>{{ order.created_at|date:"Y-m-d h:i A" }}</td>
          <td class="text-center flex justify-center gap-3">
            <!-- View Items -->
            <button class="view-items-btn flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium" data-id="{{ order.order_number }}">
              <i class="fa-solid fa-eye"></i>
            </button>
            <!-- View Invoices -->
            <a href="{% url 'admin_orders_invoice_list' order.order_number %}" class="flex items-center gap-2 text-green-600 hover:text-green-800 font-medium">
              <i class="fa-solid fa-file-invoice"></i>
            </a>
            <!-- Delete -->
            <a href="{% url 'admin_order_delete' order.order_number %}" class="flex items-center gap-2 text-red-600 hover:text-red-800 font-medium" onclick="return confirm('Delete this order?')">
              <i class="fa-solid fa-trash"></i>
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-center text-gray-500 py-6">No orders found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}


<script>
$(document).ready(function() {
    $('#ordersTable').DataTable({
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50],
        ordering: true,
        order: [[8, 'desc']], // Default sorting by Created date
        columnDefs: [
            { orderable: false, targets: 9 } // Actions column not sortable
        ],
        searching: false 
    });
});


// AJAX for status/payment change
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

$(document).on('change', '.status-select', function(){
    const row = $(this).closest('tr');
    const orderNumber = $(this).data('id');
    const status = row.find('.status-select').val();

    $.ajax({
        url: `{% url 'admin_order_change_status' 'ORD00000000000000' %}`.replace('ORD00000000000000', orderNumber),
        type: 'POST',
        data: { status },
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        success: function(resp){
            if (resp.success) location.reload();
            else alert('Failed to update order');
        },
        error: function(){ alert('Server error updating order'); }
    });
});
</script>
{% endblock %}
