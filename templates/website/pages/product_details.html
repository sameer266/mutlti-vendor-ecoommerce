{% extends 'website/components/base.html' %}

{% block title %}{{ product.name }} - Fresh Mart Store{% endblock %}

{% block extra_head %}
<style>
  /* Image Magnifier Styles */
  .image-magnifier-container {
    position: relative;
    overflow: visible;
  }
  
  .magnifier-glass {
    position: absolute;
    border: 3px solid #FF7F00;
    border-radius: 50%;
    cursor: none;
    width: 150px;
    height: 150px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
    background-repeat: no-repeat;
    background-color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 50;
  }
  
  .magnifier-glass.active {
    opacity: 1;
  }
  
  /* Variant Selection */
  .variant-option {
    transition: all 0.2s ease;
  }
  
  .variant-option.selected {
    border-color: #FF7F00 !important;
    background-color: #fff8f0 !important;
    transform: scale(1.02);
  }
  
  .variant-option:hover:not(.selected) {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  /* Thumbnail hover effect */
  .thumbnail-item {
    transition: all 0.2s ease;
  }

  .thumbnail-item:hover {
    transform: scale(1.05);
  }

  .thumbnail-item.active {
    border-color: #FF7F00 !important;
    border-width: 2px !important;
  }

  /* Smooth transitions */
  #mainImage {
    transition: opacity 0.3s ease;
  }

  /* Quantity input styling */
  .qtyInput::-webkit-inner-spin-button,
  .qtyInput::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .qtyInput {
    -moz-appearance: textfield;
  }

  /* Responsive adjustments */
  @media (max-width: 1024px) {
    .magnifier-glass {
      display: none !important;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-7xl">

  <!-- Breadcrumb -->
  <nav class="flex mb-6" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-2 text-sm">
      <li>
        <a href="{% url 'home' %}" class="text-gray-600 hover:text-[#FF7F00] transition-colors">Home</a>
      </li>
      <li class="text-gray-400">/</li>
      <li>
        <a href="{% url 'all_collections' %}" class="text-gray-600 hover:text-[#FF7F00] transition-colors">Products</a>
      </li>
      {% if product.category %}
      <li class="text-gray-400">/</li>
      <li>
        <span class="text-gray-600">{{ product.category.name }}</span>
      </li>
      {% endif %}
      <li class="text-gray-400">/</li>
      <li>
        <span class="text-gray-900 font-medium">{{ product.name }}</span>
      </li>
    </ol>
  </nav>

  <!-- Product Main Section -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 mb-16">

    <!-- Product Images -->
    <div class="space-y-4">
      <!-- Main Image with Magnifier -->
      <div class="relative aspect-square bg-white rounded-lg border border-gray-200 overflow-hidden image-magnifier-container" id="imageContainer">
        <img src="{{ product.main_image.url }}" 
             alt="{{ product.name }}" 
             class="w-full h-full object-contain p-8"
             id="mainImage">
        <div class="magnifier-glass" id="magnifierGlass"></div>
      </div>
      
      <!-- Thumbnail Images -->
      <div class="grid grid-cols-5 gap-2">
        <div class="thumbnail-item active aspect-square bg-white rounded-lg border border-gray-300 overflow-hidden cursor-pointer" 
             data-image="{{ product.main_image.url }}">
          <img src="{{ product.main_image.url }}" 
               alt="{{ product.name }}" 
               class="w-full h-full object-contain p-2">
        </div>
        {% if product.images.all %}
          {% for image in product.images.all %}
          <div class="thumbnail-item aspect-square bg-white rounded-lg border border-gray-300 overflow-hidden cursor-pointer" 
               data-image="{{ image.image.url }}">
            <img src="{{ image.image.url }}" 
                 alt="{{ product.name }}" 
                 class="w-full h-full object-contain p-2">
          </div>
          {% endfor %}
        {% endif %}
      </div>
    </div>

    <!-- Product Info -->
    <div class="space-y-6">
      <!-- Title & Vendor -->
      <div>
        <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-3">{{ product.name }}</h1>
        <a href="{% url 'vendor_details' product.vendor.slug %}" 
           class="inline-flex items-center text-sm text-gray-600 hover:text-[#FF7F00] transition-colors group">
          <i class="fas fa-store mr-2 group-hover:scale-110 transition-transform"></i>
          {{ product.vendor.shop_name }}
        </a>
      </div>

  <!-- Rating & Stats -->
<div class="flex items-center justify-between gap-6 py-3 border-y border-gray-200">
  <div class="flex items-center gap-2 text-gray-700">
    <div class="flex items-center gap-1">
      {% for i in "12345" %}
        {% if forloop.counter <= product.average_rating %}
          <i class="fas fa-star text-yellow-500 text-sm"></i>
        {% elif forloop.counter|add:-1 < product.average_rating %}
          <i class="fas fa-star-half-alt text-yellow-500 text-sm"></i>
        {% else %}
          <i class="far fa-star text-gray-300 text-sm"></i>
        {% endif %}
      {% endfor %}
    </div>
    <span class="text-sm">({{ product.reviews.count }} reviews)</span>
  </div>

  <div class="flex items-center gap-1 text-gray-400 text-sm">
    <i class="far fa-eye"></i> <span>{{ product.views_count }} views</span>
  </div>
</div>

<!-- Price -->
<div class="flex items-center gap-4">
  <span class="text-4xl font-bold text-gray-900" id="currentPrice">Rs {{ product.price|floatformat:0 }}</span>
  {% if product.cost_price and product.cost_price > product.price %}
    <span class="text-gray-400 line-through text-xl">Rs {{ product.cost_price|floatformat:0 }}</span>
    <span class="bg-red-50 text-red-600 text-sm font-semibold px-3 py-1 rounded-full shadow-sm">
      Save {{ product.discount_percentage }}%
    </span>
  {% endif %}
</div>

<!-- Stock Status -->
<div>
  {% if product.in_stock %}
    <span class="inline-flex items-center gap-2 text-green-700 font-medium bg-green-50 px-3 py-1 rounded-full shadow-sm">
      <i class="fas fa-check-circle"></i> In Stock - {{ product.stock }} units
    </span>
  {% else %}
    <span class="inline-flex items-center gap-2 text-red-700 font-medium bg-red-50 px-3 py-1 rounded-full shadow-sm">
      <i class="fas fa-times-circle"></i> Out of Stock
    </span>
  {% endif %}
</div>


    

      <!-- Product Variants -->
      {% if product.variants.all %}
      <div class="space-y-3">
        <h3 class="text-sm font-semibold text-gray-900 uppercase tracking-wide">
          Select Options
          <span class="text-gray-500 font-normal text-xs normal-case">(Click to toggle)</span>
        </h3>
        <div class="flex flex-wrap gap-2">
          {% for variant in product.variants.all %}
          <div class="variant-option border-2 border-gray-300 rounded-lg px-4 py-2.5 cursor-pointer" 
               data-variant-id="{{ variant.id }}" 
               data-price-adjustment="{{ variant.price_adjustment }}">
            <div class="flex items-center gap-2">
              <i class="far fa-circle text-xs text-gray-400 variant-icon"></i>
              <div>
                <div class="text-sm font-medium text-gray-900">{{ variant.name }}</div>
                {% if variant.price_adjustment != 0 %}
                  <div class="text-xs text-[#FF7F00] font-semibold">
                    {% if variant.price_adjustment > 0 %}+{% endif %}Rs {{ variant.price_adjustment }}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Quantity & Actions -->
      <div class="space-y-4 pt-4">
        <div class="flex items-center gap-3">
          <label class="text-sm font-semibold text-gray-700 w-20">Quantity</label>
          <div class="flex items-center border-2 border-gray-300 rounded-lg overflow-hidden">
            <button class="decreaseQty w-10 h-10 flex items-center justify-center hover:bg-gray-50 active:bg-gray-100 transition-colors text-gray-700" 
                    type="button">
              <i class="fas fa-minus text-xs"></i>
            </button>
            <input type="number" value="1" min="1" max="{{ product.stock }}" 
                   class="qtyInput w-20 h-10 text-center border-x-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#FF7F00] focus:ring-inset text-gray-900 font-medium">
            <button class="increaseQty w-10 h-10 flex items-center justify-center hover:bg-gray-50 active:bg-gray-100 transition-colors text-gray-700" 
                    type="button">
              <i class="fas fa-plus text-xs"></i>
            </button>
          </div>
        </div>

        <div class="flex gap-3">
          {% if product.in_stock %}
          <button class="addToCart flex-1 bg-[#FF7F00] hover:bg-[#E67300] active:bg-[#CC6600] text-white font-semibold py-3.5 px-6 rounded-lg transition-all shadow-sm hover:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">
            <i class="fas fa-shopping-cart mr-2"></i>
            Add to Cart
          </button>
          {% else %}
          <button class="flex-1 bg-gray-300 text-gray-500 font-semibold py-3.5 px-6 rounded-lg cursor-not-allowed" disabled>
            <i class="fas fa-ban mr-2"></i>
            Out of Stock
          </button>
          {% endif %}
          <button class="addToWishlist w-14 h-14 flex items-center justify-center border-2 border-gray-300 rounded-lg hover:border-red-500 hover:bg-red-50 transition-all group">
            <i class="far fa-heart text-lg text-gray-600 group-hover:text-red-500 transition-colors"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Description & Reviews -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-16">
    <div class="lg:col-span-2 space-y-8">
      <!-- Description -->
      <div class="bg-white rounded-lg border border-gray-200 p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
        
          Description
        </h2>
        <div class="text-gray-700 leading-relaxed">{{ product.description|safe }}</div>
      </div>

      <!-- Reviews -->
      {% if reviews %}
      <div class="bg-white rounded-lg border border-gray-200 p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
          <i class="fas fa-comments text-[#FF7F00] mr-2"></i>
          Customer Reviews
        </h2>
        <div class="space-y-4">
          {% for review in reviews %}
          <div class="border border-gray-200 rounded-lg p-5 hover:shadow-sm transition-shadow">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-[#FF7F00] to-[#FF9933] rounded-full flex items-center justify-center">
                  <i class="fas fa-user text-white text-sm"></i>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-900">{{ review.user.username }}</h4>
                  <div class="flex items-center gap-1 mt-1">
                    {% for i in "12345" %}
                      {% if forloop.counter <= review.rating %}
                        <i class="fas fa-star text-[#FF7F00] text-xs"></i>
                      {% else %}
                        <i class="far fa-star text-gray-300 text-xs"></i>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              </div>
              <span class="text-xs text-gray-500">{{ review.created_at|date:"M d, Y" }}</span>
            </div>
            {% if review.comment %}
            <p class="text-gray-700 text-sm leading-relaxed">{{ review.comment }}</p>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Product Details Sidebar -->
    <div>
      <div class="bg-white border border-gray-200 rounded-lg p-6 sticky top-24">
        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
         
          Product Details
        </h3>
        <div class="space-y-3 text-sm">
          <div class="flex justify-between items-center py-2.5 border-b border-gray-100">
            <span class="text-gray-600 font-medium">SKU</span>
            <span class="text-gray-900 font-semibold">{{ product.sku }}</span>
          </div>
          {% if product.brand %}
          <div class="flex justify-between items-center py-2.5 border-b border-gray-100">
            <span class="text-gray-600 font-medium">Brand</span>
            <span class="text-gray-900 font-semibold">{{ product.brand }}</span>
          </div>
          {% endif %}
          {% if product.weight %}
          <div class="flex justify-between items-center py-2.5 border-b border-gray-100">
            <span class="text-gray-600 font-medium">Weight</span>
            <span class="text-gray-900 font-semibold">{{ product.weight }} kg</span>
          </div>
          {% endif %}
          <div class="flex justify-between items-center py-2.5">
            <span class="text-gray-600 font-medium">Category</span>
            <span class="text-gray-900 font-semibold">{{ product.category.name|default:"N/A" }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Full Width Simple Banner Section -->
<section class="mt-12 mb-8 w-[90%] mx-auto">
  <div class="w-full overflow-hidden cursor-pointer">
    {% if banners%}
    {% for banners in banners %}
      <img src="{{ banners.image.url }}" alt="Offer" class="w-full h-auto object-cover rounded-xl">
    {% endfor %}
    {% endif %}
  </div>
</section>


  <!-- Related Products -->
  {% if related_products %}
  <section class="bg-gray-50 rounded-xl p-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-6">More from {{ product.vendor.shop_name }}</h2>
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
      {% for related_product in related_products %}
      <a href="{% url 'product_details' related_product.slug %}" 
         class="group bg-white border border-gray-200 rounded-lg overflow-hidden hover:border-[#FF7F00] hover:shadow-lg transition-all transform hover:-translate-y-1">
        <div class="aspect-square bg-white p-3">
          <img src="{{ related_product.main_image.url }}" 
               alt="{{ related_product.name }}" 
               class="w-full h-full object-contain group-hover:scale-110 transition-transform duration-300">
        </div>
        <div class="p-3 border-t border-gray-100">
          <p class="text-sm text-gray-900 mb-2 line-clamp-2  group-hover:text-[#FF7F00] transition-colors">
            {{ related_product.name }}
          </p>
          <div class="flex items-center gap-2">
            <span class="font-bold text-gray-900">Rs {{ related_product.price | floatformat:0}}</span>
            {% if related_product.cost_price and related_product.cost_price > related_product.price %}
              <span class="text-xs text-gray-400 line-through">Rs {{ related_product.cost_price }}</span>
            {% endif %}
          </div>
        </div>
      </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
  let selectedVariant = null;
  const basePrice = {{ product.price }};
  
  // ===================================
  // IMAGE MAGNIFIER WITH PROPER ZOOM
  // ===================================
  function initImageMagnifier() {
    const container = $('#imageContainer');
    const mainImage = $('#mainImage');
    const glass = $('#magnifierGlass');
    
    if (!container.length || !mainImage.length || !glass.length) return;
    
    const zoomLevel = 2.5; // Magnification level
    
    // Set background image for the magnifier
    glass.css('background-image', `url('${mainImage.attr('src')}')`);
    
    container.on('mouseenter', function() {
      glass.addClass('active');
    });
    
    container.on('mouseleave', function() {
      glass.removeClass('active');
    });
    
    container.on('mousemove', function(e) {
      moveMagnifier(e);
    });
    
    function moveMagnifier(e) {
      const containerOffset = container.offset();
      const containerWidth = container.width();
      const containerHeight = container.height();
      
      // Get cursor position relative to container
      let x = e.pageX - containerOffset.left;
      let y = e.pageY - containerOffset.top;
      
      // Prevent magnifier from going outside image boundaries
      const glassRadius = glass.width() / 2;
      
      if (x < glassRadius) x = glassRadius;
      if (y < glassRadius) y = glassRadius;
      if (x > containerWidth - glassRadius) x = containerWidth - glassRadius;
      if (y > containerHeight - glassRadius) y = containerHeight - glassRadius;
      
      // Position the magnifier glass
      glass.css({
        left: (x - glassRadius) + 'px',
        top: (y - glassRadius) + 'px'
      });
      
      // Calculate background position for zoom effect
      const bgPosX = -(x * zoomLevel - glass.width() / 2);
      const bgPosY = -(y * zoomLevel - glass.height() / 2);
      
      glass.css({
        'background-position': `${bgPosX}px ${bgPosY}px`,
        'background-size': `${containerWidth * zoomLevel}px ${containerHeight * zoomLevel}px`
      });
    }
  }
  
  initImageMagnifier();
  
  // ===================================
  // THUMBNAIL IMAGE SWITCHING
  // ===================================
  $('.thumbnail-item').on('click', function() {
    const imageUrl = $(this).data('image');
    const $mainImage = $('#mainImage');
    
    // Fade effect on change
    $mainImage.css('opacity', '0.5');
    
    setTimeout(() => {
      $mainImage.attr('src', imageUrl);
      $('#magnifierGlass').css('background-image', `url('${imageUrl}')`);
      $mainImage.css('opacity', '1');
    }, 150);
    
    // Update active thumbnail
    $('.thumbnail-item').removeClass('active border-2').addClass('border');
    $(this).addClass('active border-2').removeClass('border');
  });
  
  // ===================================
  // VARIANT SELECTION (TOGGLE)
  // ===================================
  $('.variant-option').on('click', function() {
    const $this = $(this);
    const isSelected = $this.hasClass('selected');
    
    if (isSelected) {
      // Deselect
      deselectVariant($this);
      selectedVariant = null;
    } else {
      // Deselect all first
      $('.variant-option').each(function() {
        deselectVariant($(this));
      });
      
      // Select this one
      selectVariant($this);
      selectedVariant = $this.data('variant-id');
    }
    
    updatePrice();
  });
  
  function selectVariant($element) {
    $element.addClass('selected');
    $element.find('.variant-icon')
      .removeClass('far fa-circle text-gray-400')
      .addClass('fas fa-check-circle text-[#FF7F00]');
  }
  
  function deselectVariant($element) {
    $element.removeClass('selected');
    $element.find('.variant-icon')
      .removeClass('fas fa-check-circle text-[#FF7F00]')
      .addClass('far fa-circle text-gray-400');
  }
  
  // ===================================
  // DYNAMIC PRICE UPDATE
  // ===================================
  function updatePrice() {
    let finalPrice = basePrice;
    
    if (selectedVariant) {
      const $variant = $(`.variant-option[data-variant-id="${selectedVariant}"]`);
      const priceAdjustment = parseFloat($variant.data('price-adjustment')) || 0;
      finalPrice = basePrice + priceAdjustment;
    }
    
    $('#currentPrice').text('Rs ' + finalPrice.toFixed(0));
  }
  
  // ===================================
  // QUANTITY CONTROLS
  // ===================================
  $('.increaseQty').on('click', function() {
    const $input = $(this).siblings('.qtyInput');
    const max = parseInt($input.attr('max'));
    let current = parseInt($input.val()) || 1;
    
    if (current < max) {
      $input.val(current + 1);
    } else {
      toastr.warning(`Maximum available quantity is ${max}`);
    }
  });
  
  $('.decreaseQty').on('click', function() {
    const $input = $(this).siblings('.qtyInput');
    let current = parseInt($input.val()) || 1;
    
    if (current > 1) {
      $input.val(current - 1);
    }
  });
  
  // Validate quantity input
  $('.qtyInput').on('change', function() {
    const max = parseInt($(this).attr('max'));
    const min = parseInt($(this).attr('min'));
    let value = parseInt($(this).val());
    
    if (isNaN(value) || value < min) {
      $(this).val(min);
    } else if (value > max) {
      $(this).val(max);
      toastr.warning(`Maximum available quantity is ${max}`);
    }
  });
  
  // ===================================
  // ADD TO CART
  // ===================================
  $('.addToCart').on('click', function() {
    const quantity = parseInt($('.qtyInput').val()) || 1;
    const productId = {{ product.id }};
    const variantId = selectedVariant;
    
    const $btn = $(this);
    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Adding to Cart...');
    
    $.ajax({
      url: '{% url "add_to_cart" %}',
      method: 'POST',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || $('meta[name=csrf-token]').attr('content')
      },
      contentType: 'application/json',
      data: JSON.stringify({
        product_id: productId,
        quantity: quantity,
        variant_id: variantId
      }),
      success: function(response) {
        if (response.success) {
          toastr.success(response.message || 'Product added to cart successfully!');
          
          // Update cart count
          if (typeof updateCartCount === 'function') {
            updateCartCount(response.cart_count);
          }
          if (response.cart_count > 0) {
            $('.cart-count').text(response.cart_count).show();
          }
          
          // Reset quantity to 1
          $('.qtyInput').val(1);
        } else {
          toastr.error(response.message || 'Failed to add product to cart');
        }
      },
      error: function(xhr) {
        const response = xhr.responseJSON;
        if (xhr.status === 401) {
          toastr.warning('Please login to add items to your cart');
          setTimeout(() => {
            window.location.href = '{% url "login_page" %}?next={{ request.path }}';
          }, 1500);
        } else {
          toastr.error(response?.message || 'An error occurred. Please try again.');
        }
      },
      complete: function() {
        $btn.prop('disabled', false).html(originalHtml);
      }
    });
  });
  
  // ===================================
  // ADD TO WISHLIST
  // ===================================
  $('.addToWishlist').on('click', function() {
    const $btn = $(this);
    const $heart = $btn.find('i');
    const isInWishlist = $heart.hasClass('fas');
    
    if (isInWishlist) {
      // Remove from wishlist
      $heart.removeClass('fas text-red-500').addClass('far text-gray-600');
      $btn.removeClass('border-red-500 bg-red-50');
      toastr.info('Removed from wishlist');
    } else {
      // Add to wishlist
      $heart.removeClass('far text-gray-600').addClass('fas text-red-500');
      $btn.addClass('border-red-500 bg-red-50');
      toastr.success('Added to wishlist!');
    }
    
    // TODO: Make AJAX call to backend to actually add/remove from wishlist
    // $.ajax({ url: '/wishlist/toggle/', ... });
  });
});
</script>
{% endblock %}