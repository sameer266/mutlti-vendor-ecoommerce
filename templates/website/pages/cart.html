{% extends 'website/components/base.html' %}

{% block title %}Shopping Cart{% endblock %}

{% block content %}
{% if request.user.is_authenticated %}
<div class="container mx-auto px-4 py-6 lg:py-8 max-w-7xl">
  
  <h1 class="text-2xl lg:text-3xl font-bold mb-6 text-[var(--text-primary)]">Shopping Cart</h1>

  {% if cart_items %}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">

    <!-- Cart Items Section -->
    <div class="lg:col-span-2">
      <div class="bg-[var(--bg-light)] border rounded-lg overflow-hidden shadow-[var(--shadow-sm)]">
        
        <!-- Mobile Card View -->
        <div class="block lg:hidden divide-y">
          {% for item in cart_items %}
          <div class="cart-item p-4" data-cart-item-id="{{ item.id }}">
            <div class="flex gap-3 mb-3">
              <img src="{{ item.product.main_image.url }}" 
                   alt="{{ item.product.name }}" 
                   class="w-20 h-20 object-cover rounded flex-shrink-0">
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-[var(--text-primary)] mb-1">{{ item.product.name }}</h3>
                {% if item.variant %}
                <p class="text-xs text-[var(--text-secondary)] mb-1">{{ item.variant.get_variant_type_display }}: {{ item.variant.name }} {% if item.variant.price_adjustment != 0 %}({% if item.variant.price_adjustment > 0 %}+{% endif %}Rs {{ item.variant.price_adjustment }}){% endif %}</p>
                {% endif %}
                <p class="text-xs text-[var(--text-secondary)] mb-2">SKU: {{ item.product.sku }}</p>
                <p class="item-price font-bold text-[var(--success)] text-lg">Rs {{ item.get_item_price }}</p>
              </div>
              <button class="removeItem text-red-500 hover:text-red-700 h-8 w-8 flex items-center justify-center" 
                      data-cart-item-id="{{ item.id }}">
                <i class="fa fa-trash"></i>
              </button>
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <button class="decreaseQty w-9 h-9 border border-[var(--text-secondary)] rounded hover:bg-gray-100 flex items-center justify-center" 
                        data-cart-item-id="{{ item.id }}">-</button>
                <input type="number" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}" 
                       class="qtyInput w-16 text-center border border-[var(--text-secondary)] rounded py-2 text-sm focus:ring-2 focus:ring-[var(--primary)]"
                       data-cart-item-id="{{ item.id }}">
                <button class="increaseQty w-9 h-9 border border-[var(--text-secondary)] rounded hover:bg-gray-100 flex items-center justify-center"
                        data-cart-item-id="{{ item.id }}">+</button>
              </div>
              <div class="text-right">
                <p class="text-xs text-[var(--text-secondary)]">Subtotal</p>
                <p class="item-subtotal font-bold text-[var(--text-primary)] text-lg">Rs {{ item.get_total_price }}</p>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Desktop Table View -->
        <div class="hidden lg:block overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b">
              <tr>
                <th class="text-left py-4 px-6 font-semibold text-[var(--text-primary)]">Product</th>
                <th class="text-center py-4 px-6 font-semibold text-[var(--text-primary)]">Price</th>
                <th class="text-center py-4 px-6 font-semibold text-[var(--text-primary)]">Quantity</th>
                <th class="text-center py-4 px-6 font-semibold text-[var(--text-primary)]">Subtotal</th>
                <th class="text-center py-4 px-6 font-semibold text-[var(--text-primary)]">Action</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              {% for item in cart_items %}
              <tr class="cart-item" data-cart-item-id="{{ item.id }}">
                <td class="py-4 px-6">
                  <div class="flex items-center gap-4">
                    <img src="{{ item.product.main_image.url }}" 
                         alt="{{ item.product.name }}" 
                         class="w-16 h-16 object-cover rounded">
                    <div>
                      <h3 class="font-semibold text-[var(--text-primary)]">{{ item.product.name }}</h3>
                      {% if item.variant %}
                      <p class="text-sm text-[var(--text-secondary)]">{{ item.variant.get_variant_type_display }}: {{ item.variant.name }} {% if item.variant.price_adjustment != 0 %}({% if item.variant.price_adjustment > 0 %}+{% endif %}Rs {{ item.variant.price_adjustment }}){% endif %}</p>
                      {% endif %}
                      <p class="text-xs text-[var(--text-secondary)]">SKU: {{ item.product.sku }}</p>
                    </div>
                  </div>
                </td>
                <td class="text-center py-4 px-6">
                  <span class="font-semibold text-[var(--success)]">Rs {{ item.get_item_price }}</span>
                </td>
                <td class="text-center py-4 px-6">
                  <div class="flex items-center justify-center gap-2">
                    <button class="decreaseQty w-8 h-8 border border-[var(--text-secondary)] rounded hover:bg-gray-100 flex items-center justify-center"
                            data-cart-item-id="{{ item.id }}">-</button>
                    <input type="number" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}" 
                           class="qtyInput w-16 text-center border border-[var(--text-secondary)] rounded py-1 text-sm focus:ring-2 focus:ring-[var(--primary)]"
                           data-cart-item-id="{{ item.id }}">
                    <button class="increaseQty w-8 h-8 border border-[var(--text-secondary)] rounded hover:bg-gray-100 flex items-center justify-center"
                            data-cart-item-id="{{ item.id }}">+</button>
                  </div>
                </td>
                <td class="text-center py-4 px-6">
                  <span class="font-bold text-[var(--text-primary)] item-subtotal">Rs {{ item.get_total_price }}</span>
                </td>
                <td class="text-center py-4 px-6">
                  <button class="removeItem text-red-500 hover:text-red-700 p-2" 
                          data-cart-item-id="{{ item.id }}">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Order Summary Section -->
    <div class="lg:col-span-1">
      <div class="bg-[var(--bg-light)] border rounded-lg p-6 shadow-[var(--shadow-sm)] sticky top-4">
        <h2 class="text-xl font-bold text-[var(--text-primary)] mb-4">Order Summary</h2>
        
        <div class="space-y-3 mb-6">
          <div class="flex justify-between">
            <span class="text-[var(--text-secondary)]">Items ({{ total_items }})</span>
            <span class="font-semibold text-[var(--text-primary)]">Rs {{ total_price }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-[var(--text-secondary)]">Shipping</span>
            <span class="font-semibold text-[var(--success)]">Free</span>
          </div>
          <div class="flex justify-between">
            <span class="text-[var(--text-secondary)]">Tax</span>
            <span class="font-semibold text-[var(--text-primary)]">Rs 0.00</span>
          </div>
          <hr class="my-3 border-[var(--text-secondary)]">
          <div class="flex justify-between text-lg font-bold">
            <span class="text-[var(--text-primary)]">Total</span>
            <span class="text-[var(--success)] total-price">Rs {{ total_price }}</span>
          </div>
        </div>

        <div class="space-y-3">
          <a href="{% url 'checkout_page' %}" class="block w-full text-center bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] py-3 px-4 rounded-lg font-semibold transition-colors btn btn-primary">
            Proceed to Checkout
          </a>
          <a href="{% url 'all_collections' %}" class="block w-full text-center bg-gray-100 hover:bg-gray-200 text-[var(--text-primary)] py-3 px-4 rounded-lg font-semibold transition-colors">
            Continue Shopping
          </a>
        </div>

        <!-- Security Badge -->
        <div class="mt-6 pt-4 border-t border-[var(--text-secondary)] text-center">
          <div class="flex items-center justify-center gap-2 text-sm text-[var(--text-secondary)]">
            <i class="fas fa-shield-alt text-[var(--success)]"></i>
            <span>Secure Checkout</span>
          </div>
        </div>
      </div>
    </div>

  </div>
  {% else %}
  <!-- Empty Cart -->
  <div class="text-center py-12">
    <div class="max-w-md mx-auto">
      <i class="fas fa-shopping-cart text-6xl text-gray-300 mb-6"></i>
      <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">Your Cart is Empty</h2>
      <p class="text-[var(--text-secondary)] mb-6">Looks like you haven't added any items to your cart yet.</p>
      <a href="{% url 'all_collections' %}" class="inline-block bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] px-8 py-3 rounded-lg font-semibold transition-colors btn btn-primary">
        Start Shopping
      </a>
    </div>
  </div>
  {% endif %}

</div>
{% else %}
<!-- Redirect to Login for Unauthenticated Users -->
<div class="container mx-auto px-4 py-6 lg:py-8 max-w-7xl text-center">
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">Please Log In</h2>
  <p class="text-[var(--text-secondary)] mb-6">You need to be logged in to view your shopping cart.</p>
  <a href="{% url 'login_page' %}" class="inline-block bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] px-8 py-3 rounded-lg font-semibold transition-colors btn btn-primary">
    Log In
  </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if request.user.is_authenticated %}
<script>
$(document).ready(function() {
  // Update cart item quantity
  $('.qtyInput').on('change', function() {
    const cartItemId = $(this).data('cart-item-id');
    const quantity = parseInt($(this).val());
    
    if (quantity < 1) {
      removeCartItem(cartItemId);
      return;
    }
    
    updateCartItem(cartItemId, quantity);
  });
  
  // Increase quantity
  $('.increaseQty').on('click', function() {
    const cartItemId = $(this).data('cart-item-id');
    const input = $(`.qtyInput[data-cart-item-id="${cartItemId}"]`);
    const currentQty = parseInt(input.val());
    const maxQty = parseInt(input.attr('max'));
    
    if (currentQty < maxQty) {
      input.val(currentQty + 1);
      updateCartItem(cartItemId, currentQty + 1);
    }
  });
  
  // Decrease quantity
  $('.decreaseQty').on('click', function() {
    const cartItemId = $(this).data('cart-item-id');
    const input = $(`.qtyInput[data-cart-item-id="${cartItemId}"]`);
    const currentQty = parseInt(input.val());
    
    if (currentQty > 1) {
      input.val(currentQty - 1);
      updateCartItem(cartItemId, currentQty - 1);
    } else {
      removeCartItem(cartItemId);
    }
  });
  
  // Remove item
  $('.removeItem').on('click', function() {
    const cartItemId = $(this).data('cart-item-id');
    removeCartItem(cartItemId);
  });
  
  // Update cart item function
  function updateCartItem(cartItemId, quantity) {
    $.ajax({
      url: '{% url "update_cart_item" %}',
      method: 'POST',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || $('meta[name=csrf-token]').attr('content')
      },
      contentType: 'application/json',
      data: JSON.stringify({
        cart_item_id: cartItemId,
        quantity: quantity
      }),
      success: function(response) {
        if (response.success) {
          // Update item subtotal
          $(`.cart-item[data-cart-item-id="${cartItemId}"] .item-subtotal`).text('Rs ' + response.item_total.toFixed(2));
          
          // Update total price
          $('.total-price').text('Rs ' + response.total_price.toFixed(2));
          
          // Update cart count in header if exists
          if (typeof updateCartCount === 'function') {
            updateCartCount(response.cart_count);
          }
          
          toastr.success(response.message);
        } else {
          toastr.error(response.message);
        }
      },
      error: function(xhr) {
        const response = xhr.responseJSON;
        toastr.error(response?.message || 'An error occurred while updating cart');
      }
    });
  }
  
  // Remove cart item function
  function removeCartItem(cartItemId) {
    $.ajax({
      url: '{% url "remove_from_cart" %}',
      method: 'POST',
      headers: {
        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() || $('meta[name=csrf-token]').attr('content')
      },
      contentType: 'application/json',
      data: JSON.stringify({
        cart_item_id: cartItemId
      }),
      success: function(response) {
        if (response.success) {
          // Remove item from DOM
          $(`.cart-item[data-cart-item-id="${cartItemId}"]`).fadeOut(300, function() {
            $(this).remove();
            
            // Check if cart is empty
            if ($('.cart-item').length === 0) {
              location.reload(); // Reload to show empty cart message
            }
          });
          
          // Update total price
          $('.total-price').text('Rs ' + response.total_price.toFixed(2));
          
          // Update cart count in header if exists
          if (typeof updateCartCount === 'function') {
            updateCartCount(response.cart_count);
          }
          
          toastr.success(response.message);
        } else {
          toastr.error(response.message);
        }
      },
      error: function(xhr) {
        const response = xhr.responseJSON;
        toastr.error(response?.message || 'An error occurred while removing item');
      }
    });
  }
});
</script>
{% endif %}
{% endblock %}