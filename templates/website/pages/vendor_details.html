{% extends 'website/components/base.html' %}

{% block title %}{{ vendor.shop_name }} - Vendor Details{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">

  <!-- Vendor Header -->
  <div class="vendor-header bg-white rounded-3xl shadow-[var(--shadow-sm)] mb-12 overflow-hidden">
    <!-- Banner with Gradient Overlay -->
    <div class="relative w-full h-64 lg:h-80">
      <img src="{% if vendor.shop_banner %}{{ vendor.shop_banner.url }}{% else %}https://via.placeholder.com/1200x400?text={{ vendor.shop_name|urlencode }}{% endif %}" 
           alt="{{ vendor.shop_name }} Banner" 
           class="w-full h-full object-cover transition-transform duration-500">
      <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
      <!-- Logo -->
      <div class="absolute bottom-4 left-4">
        <img src="{% if vendor.shop_logo %}{{ vendor.shop_logo.url }}{% else %}https://via.placeholder.com/100?text=Logo{% endif %}" 
             alt="{{ vendor.shop_name }} Logo" 
             class="w-24 h-24 rounded-full border-4 border-white shadow-md object-cover">
      </div>
    </div>
    <!-- Vendor Info -->
    <div class="p-6 lg:p-8">
      <h1 class="text-3xl lg:text-4xl font-bold text-[var(--text-primary)] mb-2">{{ vendor.shop_name }}</h1>
      <!-- Rating -->
      <div class="flex items-center gap-2 mb-3">
        {% with avg_rating=vendor.average_rating|floatformat:1 %}
          {% for i in '12345'|make_list %}
            <i class="fas fa-star {% if forloop.counter0 >= avg_rating|floatformat:0 %}text-gray-300{% else %}text-yellow-400{% endif %}"></i>
          {% endfor %}
          <span class="text-[var(--text-secondary)] text-sm">{{ avg_rating }}</span>
        {% endwith %}
      </div>
      <p class="text-[var(--text-secondary)] text-base mb-4">{{ vendor.description|default:"Explore quality products from this trusted vendor." }}</p>
      <!-- Stats -->
      <div class="flex flex-wrap gap-6 text-[var(--text-secondary)] text-sm">
        <div class="flex items-center gap-2">
          <i class="fas fa-box text-[var(--primary)]"></i>
          <span>{{ vendor.products.count }} Products</span>
        </div>
        {% if vendor.verification_status == 'verified' %}
          <div class="flex items-center gap-2">
            <i class="fas fa-check-circle text-[var(--success)]"></i>
            <span>Verified Vendor</span>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Vendor Products Section -->
  <section>
    <div class="flex flex-col lg:flex-row justify-between items-start gap-4 mb-6">
      <h2 class="text-2xl lg:text-3xl font-bold text-[var(--text-primary)]">Products</h2>
      <div class="flex flex-col lg:flex-row gap-4 w-full lg:w-auto">
        <input type="text" id="productSearch" placeholder="Search products..." 
               class="px-4 py-2 border rounded-lg focus:outline-none focus:border-[var(--primary)] transition">
        <select id="categoryFilter" class="px-4 py-2 border rounded-lg focus:outline-none focus:border-[var(--primary)] transition">
          <option value="">All Categories</option>
          {% for category in vendor_categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
          {% endfor %}
        </select>
        <select id="sortProducts" class="px-4 py-2 border rounded-lg focus:outline-none focus:border-[var(--primary)] transition">
          <option value="">Sort by</option>
          <option value="price-asc">Price: Low to High</option>
          <option value="price-desc">Price: High to Low</option>
          <option value="name-asc">Name: A-Z</option>
          <option value="name-desc">Name: Z-A</option>
          <option value="rating-desc">Highest Rated</option>
        </select>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="products-grid grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 lg:gap-4">
      {% for product in products %}
      <div class="product-card relative bg-gray-100 rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300 w-full max-w-[250px] mx-auto cursor-pointer"
           data-product-id="{{ product.id }}"
           data-price="{{ product.price }}"
           data-category="{{ product.category.id|default:'' }}"
           data-name="{{ product.name|lower }}"
           data-in-stock="{{ product.in_stock|yesno:'true,false' }}"
           data-rating="{{ product.average_rating|floatformat:1 }}">
        <a href="{% url 'product_details' product.slug %}" class="block relative group bg-white rounded-xl m-2">
          <img src="{{ product.main_image.url|default:'https://via.placeholder.com/200' }}"
               alt="{{ product.name }}"
               class="w-full h-48 sm:h-56 md:h-60 object-contain rounded-xl transition-transform duration-300 group-hover:scale-105">
          {% if product.discount_percentage > 0 %}
          <div class="absolute top-2 left-2 flex flex-col items-center z-20">
            <i class="fa-solid fa-bookmark text-5xl text-yellow-500"></i>
            <span class="-mt-11 text-xs font-bold text-gray-900 text-center leading-tight">
              {{ product.discount_percentage }}%<br>OFF
            </span>
          </div>
          {% endif %}
          {% if not product.in_stock %}
          <div class="absolute inset-0 bg-black/50 flex items-center justify-center rounded-xl">
            <span class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold text-sm">
              Out of Stock
            </span>
          </div>
          {% endif %}
        </a>

        <section class="p-2 sm:p-3 space-y-1 sm:space-y-2">
          <div class="flex justify-between items-start gap-2">
         <a href="{% url 'product_details' product.slug %}" class="text-xs sm:text-sm text-[var(--text-primary)] line-clamp-2 hover:underline">{{ product.name }}</a>
            {% if product.in_stock %}
            <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full font-medium whitespace-nowrap">
              In Stock
            </span>
            {% else %}
            <span class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded-full font-medium whitespace-nowrap">
              Out of Stock
            </span>
            {% endif %}
          </div>

          <div class="flex items-center justify-start mt-1 gap-2">
            {% if product.cost_price > product.price %}
            <p class="text-xs sm:text-sm text-gray-400 line-through">Rs {{ product.cost_price|floatformat:0 }}</p>
            {% endif %}
            <p class="font-bold text-orange-600 text-sm sm:text-base">Rs {{ product.price|floatformat:0 }}</p>
          </div>

          <div class="flex flex-wrap items-center justify-between gap-2 mt-2">
            <div class="flex items-center border-2 border-gray-300 rounded-lg overflow-hidden">
              <button class="decreaseQty px-2 py-1 bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-700 text-sm transition"
                      {% if not product.in_stock %}disabled{% endif %}>
                <i class="fas fa-minus text-xs"></i>
              </button>
              <input type="number" value="1" min="1" max="{% if product.in_stock %}{{ product.stock|default:10 }}{% else %}0{% endif %}"
                     class="qtyInput w-12 text-center text-sm border-x-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-inset font-medium text-gray-900"
                     {% if not product.in_stock %}disabled{% endif %}>
              <button class="increaseQty px-2 py-1 bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-700 text-sm transition"
                      {% if not product.in_stock %}disabled{% endif %}>
                <i class="fas fa-plus text-xs"></i>
              </button>
            </div>

            <button class="add-to-cart flex-1 flex items-center justify-center gap-1 text-xs sm:text-sm px-3 py-2 bg-orange-500 cursor-pointer text-white rounded-lg hover:bg-orange-600 active:bg-orange-700 transition shadow-sm hover:shadow-md font-medium"
                    data-product-id="{{ product.id }}"
                    data-product-name="{{ product.name }}"
                    {% if not product.in_stock %}disabled{% endif %}>
              <i class="fa-solid fa-cart-shopping text-xs sm:text-sm"></i>
              <span>Add</span>
            </button>
          </div>
        </section>
      </div>
      {% empty %}
      <div class="col-span-full text-center py-12">
        <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
        <p class="text-gray-500 text-lg font-medium">No products available.</p>
      </div>
      {% endfor %}
    </div>

    <!-- No Results Message -->
    <div id="noResultsMessage" class="hidden col-span-full text-center py-12 bg-white rounded-lg shadow-sm">
      <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
      <p class="text-gray-600 text-lg font-medium mb-2">No products match your filters</p>
    </div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
  // Toastr helper
  function showToast(message, type = 'info') {
    toastr.options = {
      closeButton: true,
      progressBar: true,
      positionClass: "toast-top-right",
      timeOut: 3000,
      preventDuplicates: true
    };
    switch (type) {
      case 'success': toastr.success(message); break;
      case 'error': toastr.error(message); break;
      case 'warning': toastr.warning(message); break;
      default: toastr.info(message); break;
    }
  }

  // Quantity Controls
  $(document).on('click', '.increaseQty', function() {
    const $input = $(this).siblings('.qtyInput');
    const max = parseInt($input.attr('max')) || 10;
    const current = parseInt($input.val()) || 1;
    if (current < max) {
      $input.val(current + 1);
    } else {
      showToast('Maximum quantity reached', 'warning');
    }
  });

  $(document).on('click', '.decreaseQty', function() {
    const $input = $(this).siblings('.qtyInput');
    const current = parseInt($input.val()) || 1;
    if (current > 1) {
      $input.val(current - 1);
    }
  });

  $(document).on('input', '.qtyInput', function() {
    const $input = $(this);
    const max = parseInt($input.attr('max')) || 10;
    const min = parseInt($input.attr('min')) || 1;
    let value = parseInt($input.val());
    if (isNaN(value) || value < min) {
      value = min;
    } else if (value > max) {
      value = max;
      showToast('Maximum quantity reached', 'warning');
    }
    $input.val(value);
  });

  // Add to Cart
  $(document).on('click', '.add-to-cart', function(e) {
    e.preventDefault();
    const $btn = $(this);
    const $card = $btn.closest('.product-card');
    const qty = parseInt($card.find('.qtyInput').val()) || 1;
    const productId = $btn.data('product-id');
    const productName = $btn.data('product-name');
    const inStock = $card.data('in-stock') === true;

    if (!inStock) {
      showToast(`${productName} is out of stock`, 'error');
      return;
    }

    if (qty <= 0) {
      showToast('Please select a valid quantity', 'error');
      return;
    }

    const originalHtml = $btn.html();
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

    $.ajax({
      url: '/api/cart/add/',
      method: 'POST',
      headers: { 
        'X-CSRFToken': '{{ csrf_token }}' 
      },
      contentType: 'application/json',
      data: JSON.stringify({
        product_id: productId,
        quantity: qty,
        variant_id: null
      }),
      success: function(response) {
        if (response.success) {
          showToast(`${qty} Ã— ${productName} added to cart!`, 'success');
          $('#desktopCartBadge, #mobileCartBadge').text(response.cart_count).show();
          $card.find('.qtyInput').val(1);
        } else {
          showToast(response.message || 'Failed to add to cart', 'error');
        }
      },
      error: function(xhr) {
        const response = xhr.responseJSON;
        if (xhr.status === 401 || xhr.status === 403) {
          showToast('Please login to add items to cart', 'warning');
          setTimeout(() => {
            window.location.href = '{% url "login_page" %}?next={{ request.path }}';
          }, 1500);
        } else {
          showToast(response?.message || 'An error occurred while adding to cart', 'error');
        }
      },
      complete: function() {
        $btn.prop('disabled', false).html(originalHtml);
      }
    });
  });

  // Real-Time Filtering and Sorting
  function filterAndSortProducts() {
    const searchQuery = $('#productSearch').val().toLowerCase().trim();
    const categoryFilter = $('#categoryFilter').val();
    const sortOption = $('#sortProducts').val();
    
    let $products = $('.product-card');
    let matchedProducts = $products;

    // Filter by search query
    if (searchQuery) {
      matchedProducts = matchedProducts.filter(function() {
        const name = $(this).data('name') || '';
        return name.includes(searchQuery);
      });
    }

    // Filter by category
    if (categoryFilter) {
      matchedProducts = matchedProducts.filter(function() {
        return $(this).data('category') == categoryFilter;
      });
    }

    // Show/hide products
    $products.hide();
    matchedProducts.show();

    // Sort products
    if (sortOption) {
      matchedProducts.sort(function(a, b) {
        if (sortOption === 'price-asc') {
          return $(a).data('price') - $(b).data('price');
        } else if (sortOption === 'price-desc') {
          return $(b).data('price') - $(a).data('price');
        } else if (sortOption === 'name-asc') {
          return $(a).data('name').localeCompare($(b).data('name'));
        } else if (sortOption === 'name-desc') {
          return $(b).data('name').localeCompare($(a).data('name'));
        } else if (sortOption === 'rating-desc') {
          return $(b).data('rating') - $(a).data('rating');
        }
        return 0;
      });

      $('.products-grid').empty().append(matchedProducts);
    }

    // Show/hide no results message
    if (matchedProducts.length === 0) {
      $('#noResultsMessage').removeClass('hidden');
    } else {
      $('#noResultsMessage').addClass('hidden');
    }
  }

  // Bind filter and sort events
  $('#productSearch').on('input', filterAndSortProducts);
  $('#categoryFilter, #sortProducts').on('change', filterAndSortProducts);

  // Initial filter application
  filterAndSortProducts();
});
</script>
{% endblock %}