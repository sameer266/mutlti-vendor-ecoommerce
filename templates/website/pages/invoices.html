{% extends 'website/components/base.html' %}
{% load static %}

{% block title %}My Invoices{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 sm:py-8 lg:py-12 max-w-7xl">
  <div class="flex flex-col lg:flex-row gap-6 lg:gap-8">

    <!-- Sidebar -->
    <aside class="w-full lg:w-64 flex-shrink-0">
      {% include 'website/components/customer_sidebar.html' %}
    </aside>

    <!-- Main Content -->
    <main class="flex-1 min-w-0">

      <!-- Header -->
      <header class="bg-white rounded-2xl shadow-sm p-6 mb-6 border border-gray-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 mb-1">My Invoices</h1>
          <p class="text-sm text-gray-600">View and manage your invoices</p>
        </div>
        <div class="flex items-center gap-4">
          <label class="text-sm text-gray-700 font-medium">Filter by Status:</label>
          <select id="statusFilter" class="border rounded px-3 py-1 text-sm">
            <option value="">All</option>
            <option value="pending">Pending</option>
            <option value="paid">Paid</option>
            <option value="failed">Failed</option>
          </select>

          <label class="text-sm text-gray-700 font-medium">Filter by Date:</label>
          <input type="date" id="dateFilter" class="border rounded px-3 py-1 text-sm">
        </div>
      </header>

      {% if page_obj %}
      <div class="overflow-x-auto bg-white rounded-2xl shadow-sm border border-gray-100">
        <table class="min-w-full divide-y divide-gray-200" id="invoiceTable">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice #</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order #</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for invoice in page_obj %}
            <tr data-status="{{ invoice.payment_status }}" data-date="{{ invoice.created_at|date:'Y-m-d' }}">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ invoice.invoice_number }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ invoice.order.order_number }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                  {% if invoice.payment_status == 'pending' %}bg-yellow-100 text-yellow-800
                  {% elif invoice.payment_status == 'paid' %}bg-green-100 text-green-800
                  {% elif invoice.payment_status == 'failed' %}bg-red-100 text-red-800
                  {% else %}bg-gray-100 text-gray-800{% endif %}">
                  {{ invoice.payment_status|capfirst }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Rs {{ invoice.total }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ invoice.created_at|date:"M d, Y h:i A" }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <a href="{% url 'customer_invoice_detail' invoice.invoice_number %}" class="text-white bg-[var(--primary)] px-4 py-2 rounded-lg hover:bg-[var(--primary-dark)]">View</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="mt-6 flex justify-center">
        <div class="flex items-center gap-2">
          {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">&lt; Prev</a>
          {% endif %}
          <span class="px-3 py-1 bg-[var(--primary)] text-white rounded">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">Next &gt;</a>
          {% endif %}
        </div>
      </div>
      {% else %}
      <div class="text-center py-20">
        <i class="fa-solid fa-file-invoice text-5xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-bold mb-2">No Invoices Yet</h3>
        <p class="text-gray-600 mb-6">You haven't received any invoices yet. Place an order to generate invoices.</p>
        <a href="{% url 'all_collections' %}" class="px-6 py-3 bg-[var(--primary)] text-white rounded-lg hover:bg-[var(--primary-dark)]">Start Shopping</a>
      </div>
      {% endif %}
    </main>
  </div>
</div>

<!-- jQuery for filtering -->

<script>
  $(document).ready(function(){
    $('#statusFilter, #dateFilter').on('change', function(){
      var status = $('#statusFilter').val();
      var date = $('#dateFilter').val();

      $('#invoiceTable tbody tr').each(function(){
        var rowStatus = $(this).data('status');
        var rowDate = $(this).data('date');
        var show = true;

        if(status && rowStatus !== status){
          show = false;
        }
        if(date && rowDate !== date){
          show = false;
        }

        $(this).toggle(show);
      });
    });
  });
</script>
{% endblock %}
