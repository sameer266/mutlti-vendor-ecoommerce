{% extends 'website/components/base.html' %} {% block title %}All Collections{%endblock %} {% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="flex flex-col lg:flex-row gap-6 lg:gap-8">
    <!-- Sidebar -->
    <aside class="lg:w-1/5 w-full order-2 lg:order-1">
      {% include 'website/components/sidebar.html' %}
    </aside>

    <!-- Products Section -->
    <section class="lg:w-4/5 w-full order-1 lg:order-2">
      <!-- Page Header -->
      <div class="text-center mb-8 bg-[var(--bg-brown)] p-4 rounded shadow">
        <h1 class="text-2xl sm:text-3xl font-extrabold text-white">
          All Collections
        </h1>
        <p class="text-white text-sm mt-2 max-w-md mx-auto">
          Explore our latest collections of fresh and quality products.
        </p>
      </div>

      <!-- Filter Info Bar -->
      <div
        class="bg-white rounded-lg shadow-sm p-4 mb-6 flex items-center justify-between"
      >
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600">Showing</span>
          <span class="font-semibold text-orange-600" id="productCount">0</span>
          <span class="text-sm text-gray-600">products</span>
        </div>
        <button
          id="clearFilters"
          class="text-sm text-orange-600 hover:text-orange-700 font-medium hidden"
        >
          <i class="fas fa-times-circle mr-1"></i>
          Clear Filters
        </button>
      </div>

      <!-- Products Grid -->
      <div
        class="products-grid grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 lg:gap-4"
      >
        {% for product in products %}
        <div
          class="product-card relative bg-gray-100 rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300 w-full max-w-[250px] mx-auto cursor-pointer"
          data-product-id="{{ product.id }}"
          data-price="{{ product.price }}"
          data-category="{{ product.category.id|default:'' }}"
          data-brand="{{ product.brand|default:'' }}"
          data-tags="{% for tag in product.tags.all %}{{ tag.name|lower }}{% if not forloop.last %},{% endif %}{% endfor %}"
          data-in-stock="{{ product.in_stock|yesno:'true,false' }}"
        >
          <a
            href="{% url 'product_details' product.slug %}"
            class="block relative group bg-white rounded-xl m-2"
          >
            <img
              src="{{ product.main_image.url|default:'https://via.placeholder.com/200' }}"
              alt="{{ product.name }}"
              class="w-full h-48 sm:h-56 md:h-60 object-contain rounded-xl transition-transform duration-300 group-hover:scale-105"
            />

            {% if product.discount_percentage > 0 %}
            <div class="absolute top-2 left-2 flex flex-col items-center z-20">
              <i class="fa-solid fa-bookmark text-5xl text-yellow-500"></i>
              <span
                class="-mt-11 text-xs font-bold text-gray-900 text-center leading-tight"
              >
                {{ product.discount_percentage }}%<br />OFF
              </span>
            </div>
            {% endif %} {% if not product.in_stock %}
            <div
              class="absolute inset-0 bg-black/50 flex items-center justify-center rounded-xl"
            >
              <span
                class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold text-sm"
              >
                Out of Stock
              </span>
            </div>
            {% endif %}
          </a>

          <!-- Product Info -->
          <!-- Product Info -->
          <section class="p-2 sm:p-3 space-y-1 sm:space-y-2">
            <div class="flex justify-between items-start gap-2">
              <a
                href="{% url 'product_details' product.slug %}"
                class="text-sm text-[var(--text-primary)] line-clamp-2 hover:underline"
              >
                {{ product.name }}
              </a>
               <p class="text-xs font-medium {% if product.in_stock %}text-green-600{% else %}text-red-600{% endif %}">
                {% if product.in_stock %}In Stock{% else %}Out of Stock{% endif %}
              </p>
            </div>

            <div class="flex items-center justify-start mt-1 gap-2">
              {% if product.cost_price > product.price %}
              <p class="text-xs sm:text-sm text-gray-400 line-through">
                Rs {{ product.cost_price|floatformat:0 }}
              </p>
              {% endif %}
              <p class="font-bold text-orange-600 text-sm sm:text-base">
                Rs {{ product.price|floatformat:0 }}
              </p>
            </div>

            <!-- Quantity & Add to Cart -->
            <div class="flex flex-wrap items-center justify-between gap-2 mt-2">
              <div
                class="flex items-center border-2 border-gray-300 rounded-lg overflow-hidden"
              >
                <button
                  class="decreaseQty px-2 py-1 bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-700 text-sm transition"
                  {%
                  if
                  not
                  product.in_stock
                  %}disabled{%
                  endif
                  %}
                >
                  <i class="fas fa-minus text-xs"></i>
                </button>
                <input
                  type="number"
                  value="1"
                  min="1"
                  max="{% if product.in_stock %}{{ product.stock|default:10 }}{% else %}0{% endif %}"
                  class="qtyInput w-12 text-center text-sm border-x-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-inset font-medium text-gray-900"
                  {%
                  if
                  not
                  product.in_stock
                  %}disabled{%
                  endif
                  %}
                />
                <button
                  class="increaseQty px-2 py-1 bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-700 text-sm transition"
                  {%
                  if
                  not
                  product.in_stock
                  %}disabled{%
                  endif
                  %}
                >
                  <i class="fas fa-plus text-xs"></i>
                </button>
              </div>

              <button
                class="add-to-cart cursor-pointer flex-1 flex items-center justify-center gap-1 text-xs sm:text-sm px-3 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 active:bg-orange-700 transition shadow-sm hover:shadow-md font-medium"
                data-product-id="{{ product.id }}"
                data-product-name="{{ product.name }}"
                {%
                if
                not
                product.in_stock
                %}disabled{%
                endif
                %}
              >
                <i class="fa-solid fa-cart-shopping text-xs sm:text-sm"></i>
                <span>Add</span>
              </button>
            </div>
          </section>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-12">
          <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
          <p class="text-gray-500 text-lg font-medium">
            No products available.
          </p>
        </div>
        {% endfor %}
      </div>

      <!-- No Results Message -->
      <div
        id="noResultsMessage"
        class="hidden col-span-full text-center py-12 bg-white rounded-lg shadow-sm"
      >
        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
        <p class="text-gray-600 text-lg font-medium mb-2">
          No products match your filters
        </p>
        <p class="text-gray-500 text-sm">Try adjusting your filter criteria</p>
        <button
          id="clearFiltersBtn"
          class="mt-4 px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition font-medium"
        >
          Clear All Filters
        </button>
      </div>

      <!-- Load More Button -->
      {% if products.has_next %}
      <div class="text-center mt-8">
        <button
          id="loadMoreBtn"
          class="px-8 py-3 bg-orange-500 text-white rounded-full shadow-md hover:bg-orange-600 hover:shadow-lg transition transform hover:-translate-y-0.5 font-medium"
          data-next-page="{{ products.next_page_number|default:2 }}"
        >
          <i class="fas fa-arrow-down mr-2"></i>
          Load More Products
        </button>
      </div>
      {% endif %}
    </section>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  $(document).ready(function () {
    function showToast(message, type = "info") {
      toastr.options = {
        closeButton: true,
        progressBar: true,
        positionClass: "toast-top-right",
        timeOut: 3000,
        preventDuplicates: true,
      };
      toastr[type](message);
    }

    function filterProducts() {
      const minPrice = parseFloat($("#minPrice").val()) || 0;
      const maxPrice = parseFloat($("#maxPrice").val()) || Infinity;

      const selectedCategories = $('input[name="category"]:checked')
        .map(function () {
          return $(this).val();
        })
        .get();
      const selectedBrands = $('input[name="brand"]:checked')
        .map(function () {
          return $(this).val().toLowerCase();
        })
        .get();
      const selectedTags = $('input[name="tag"]:checked')
        .map(function () {
          return $(this).val().toLowerCase();
        })
        .get();

      let visibleCount = 0;
      let hasFilters =
        minPrice > 0 ||
        maxPrice < Infinity ||
        selectedCategories.length > 0 ||
        selectedBrands.length > 0 ||
        selectedTags.length > 0;

      $(".product-card").each(function () {
        const $card = $(this);
        const price = parseFloat($card.data("price")) || 0;
        const category = $card.data("category").toString();
        const brand = ($card.data("brand") || "").toLowerCase();
        const tags = $card.data("tags")
          ? $card
              .data("tags")
              .split(",")
              .map((t) => t.trim().toLowerCase())
          : [];
        let show = true;
        if (price < minPrice || price > maxPrice) show = false;
        if (selectedCategories.length && !selectedCategories.includes(category))
          show = false;
        if (selectedBrands.length && !selectedBrands.includes(brand))
          show = false;
        if (selectedTags.length && !selectedTags.some((t) => tags.includes(t)))
          show = false;
        if (show) {
          $card.show();
          visibleCount++;
        } else {
          $card.hide();
        }
      });

      $("#productCount").text(visibleCount);
      $("#noResultsMessage").toggleClass("hidden", visibleCount > 0);
      $(".products-grid").toggleClass("hidden", visibleCount === 0);
      $("#clearFilters").toggleClass("hidden", !hasFilters);
    }

    function clearAllFilters() {
      $("#minPrice,#maxPrice").val("");
      $("#priceRange").val($("#priceRange").attr("min"));
      $('input[name="category"],input[name="brand"],input[name="tag"]').prop(
        "checked",
        false
      );
      filterProducts();
      showToast("All filters cleared", "info");
    }

    $("#clearFilters,#clearFiltersBtn").on("click", clearAllFilters);
    $("#minPrice,#maxPrice").on("input", filterProducts);
    $('input[name="category"],input[name="brand"],input[name="tag"]').on(
      "change",
      filterProducts
    );
    $("#priceRange").on("input", function () {
      $("#maxPrice").val($(this).val());
      filterProducts();
    });

    $(document).on("click", ".increaseQty", function () {
      const $input = $(this).siblings(".qtyInput");
      const max = parseInt($input.attr("max")) || 10;
      const current = parseInt($input.val()) || 1;
      if (current < max) $input.val(current + 1);
      else showToast("Maximum quantity reached", "warning");
    });
    $(document).on("click", ".decreaseQty", function () {
      const $input = $(this).siblings(".qtyInput");
      const current = parseInt($input.val()) || 1;
      if (current > 1) $input.val(current - 1);
    });
    $(document).on("input", ".qtyInput", function () {
      const $input = $(this);
      const max = parseInt($input.attr("max")) || 10;
      const min = parseInt($input.attr("min")) || 1;
      let value = parseInt($input.val());
      if (isNaN(value) || value < min) value = min;
      else if (value > max) {
        value = max;
        showToast("Maximum quantity reached", "warning");
      }
      $input.val(value);
    });

    $(document).on("click", ".add-to-cart", function (e) {
      e.preventDefault();
      const $btn = $(this);
      const $card = $btn.closest(".product-card");
      const qty = parseInt($card.find(".qtyInput").val()) || 1;
      const productId = $btn.data("product-id");
      const productName = $btn.data("product-name");
      const inStock = $card.data("in-stock") === true;
      if (!inStock) {
        showToast(`${productName} is out of stock`, "error");
        return;
      }
      if (qty <= 0) {
        showToast("Please select a valid quantity", "error");
        return;
      }
      const originalHtml = $btn.html();
      $btn
        .prop("disabled", true)
        .html('<i class="fas fa-spinner fa-spin"></i>');

      $.ajax({
        url: '{% url "add_to_cart" %}',
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        contentType: "application/json",
        data: JSON.stringify({
          product_id: productId,
          quantity: qty,
          variant_id: null,
        }),
        success: function (resp) {
          if (resp.success) {
            showToast(`${qty} Ã— ${productName} added to cart!`, "success");
            const cartCount = resp.cart_count || 0;
            $("#desktopCartBadge,#mobileCartBadge").text(cartCount);
            if (cartCount > 0) $("#desktopCartBadge,#mobileCartBadge").show();
            $card.find(".qtyInput").val(1);
          } else showToast(resp.message || "Failed to add to cart", "error");
        },
        error: function (xhr) {
          const resp = xhr.responseJSON;
          if (xhr.status === 401 || xhr.status === 403) {
            showToast("Please login to add items to cart", "warning");
            setTimeout(() => {
              window.location.href =
                '{% url "login_page" %}?next={{ request.path }}';
            }, 1500);
          } else
            showToast(
              resp?.message || "An error occurred while adding to cart",
              "error"
            );
        },
        complete: function () {
          $btn.prop("disabled", false).html(originalHtml);
        },
      });
    });

    $("#loadMoreBtn").on("click", function () {
      const $btn = $(this);
      const nextPage = $btn.data("next-page");
      if (!nextPage) return;
      const urlParams = new URLSearchParams(window.location.search);
      urlParams.set("page", nextPage);
      const originalHtml = $btn.html();
      $btn
        .prop("disabled", true)
        .html('<i class="fas fa-spinner fa-spin mr-2"></i>Loading...');
      $.ajax({
        url: `?${urlParams.toString()}`,
        method: "GET",
        success: function (resp) {
          const $newProducts = $(resp).find(".product-card");
          if ($newProducts.length > 0) {
            $(".products-grid").append($newProducts);
            const $newLoadBtn = $(resp).find("#loadMoreBtn");
            const newNextPage = $newLoadBtn.data("next-page");
            if (newNextPage) {
              $btn.data("next-page", newNextPage);
              $btn.prop("disabled", false).html(originalHtml);
            } else $btn.remove();
          } else $btn.remove();
          filterProducts();
        },
        error: function () {
          showToast("Failed to load more products", "error");
          $btn.prop("disabled", false).html(originalHtml);
        },
      });
    });

    filterProducts();
  });
</script>
{% endblock %}
